<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE sect3 [
		<!ENTITY % darktable_ent SYSTEM "../../../darktable.ent">
		%darktable_ent;
]>

<sect3
    version="5.0"
    xmlns="http://docbook.org/ns/docbook" 
    xmlns:xi="http://www.w3.org/2001/XInclude" 
    xmlns:xlink="http://www.w3.org/1999/xlink" 
    xml:lang="en"
    status="final"
    xml:id="highlight_reconstruction">

  <title>Highlight reconstruction</title>

  <indexterm>
    <primary>modules</primary>
    <secondary>highlight reconstruction</secondary>
  </indexterm>

  <indexterm>
    <primary>highlight reconstruction</primary>
  </indexterm>

  <indexterm>
    <primary>artifact mitigation</primary>
    <secondary>magenta highlights</secondary>
  </indexterm>

  <sect4>

    <title>Overview</title>

    <informaltable frame="none">
      <tgroup cols="2" colsep="0" rowsep="0">
        <colspec colwidth="6*"/>
        <colspec colwidth="4*"/>
        <tbody>
          <row>
            <entry>
              This module tries to reconstruct color information that is usually clipped because
              of incomplete information in some of the channels. If you do nothing, your clipped
              areas are often toned to the not clipped channel. For example, if your green and
              blue channels are clipped, then your image will appear red in the clipped areas.
            </entry>
            <entry>
              <mediaobject>
		<imageobject>
		  <imagedata fileref="darkroom/modules/images/highlightreconstruction.png" scalefit="1" width="80%" align="center" />
		</imageobject>
	      </mediaobject>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>

  </sect4>

  <sect4>

    <title>Usage</title>

    <para>
      You can choose between three methods for highlight reconstruction.
    </para>

    <para>
      <quote>Clip highlights</quote> just clamps all the pixels to the white level. Effectively
      this converts all clipped highlights to neutral grey tones. This method is most useful in
      cases where clipped highlights occur in non-colored areas like clouds in the sky.
    </para>

    <para>
      <quote>Reconstruct in LCh</quote> analyses each pixel having at least one channel clipped
      and transforms the information in LCh color space in an attempt to correct the clipped
      pixel using the values of the other (3 for Bayer or 8 for X-Trans) pixels in the affected
      sensor block. This method usually does a better job than <quote>Clip highlights</quote> as
      some details in the clipped areas are preserved. However it is incapable to reconstruct
      any color information &nbsp;&ndash; the reconstructed highlights will all be monochrome,
      but brighter and with more detail than with <quote>Clip highlights</quote>. This method
      works fairly well with a high-contrast base curve (such as most manufacturers apply to
      their JPEG), which renders highlights desaturated. This method is a good option on
      naturally desaturated objects such as clouds.
    </para>

    <para>
      <quote>Reconstruct color</quote> uses an algorithm that transfers color information from
      the unclipped surroundings into the clipped highlights. This method works very well on
      areas with homogeneous colors and is especially useful on skin tones with smoothly fading
      highlights. It fails in certain cases where it produces maze-like artifacts at highlights
      behind high-contrast edges, such as fine, well-exposed structures in front of overexposed
      background (for instance ship masts or flags in front of the blown-out sky).
    </para>

    <para>
      Tip: for highlight reconstruction to be effective you need to apply a negative EV
      correction in the exposure module (see <xref linkend="exposure"/>). If you want to avoid a
      general darkening of your image you can use darktable's mask feature in that module to
      limit the EV correction to only the highlights (see <xref linkend="drawn_mask"/> and
      <xref linkend="parametric_mask"/>).
    </para>

    <sect5>
      <title>method</title>
      <para>
        Choose the method for highlight reconstruction.
      </para>
    </sect5>

    <sect5>
      <title>clipping threshold</title>
      <para>
        Manually adjust the clipping threshold against magenta highlights. The default is
        usually satisfactory without any need for additional adjustments.
      </para>
    </sect5>

  </sect4>

</sect3>
